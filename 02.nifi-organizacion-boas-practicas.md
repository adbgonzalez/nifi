# 02. Organización do fluxo e boas prácticas en Apache NiFi

# Organización do fluxo e boas prácticas en Apache NiFi

Este documento recolle recomendacións, patróns e técnicas para manter fluxos limpos, mantibles e reutilizables en Apache NiFi. É especialmente útil cando o fluxo crece ou cando varios usuarios traballan no mesmo entorno.

---

# 1. Estrutura recomendada dun proxecto NiFi

Para evitar un canvas desordenado, recoméndase estruturar o fluxo en Process Groups seguindo unha lóxica modular.

## 1.1. Organizar fluxos en Process Groups
Un Process Group (PG) é coma unha “carpeta” ou “subfluxo”. Permite:

- agrupar procesadores que traballan nunha mesma tarefa,
- reproducir estruturas reutilizables,
- ocultar complexidade,
- permitir permisos e versionado granular.

### Exemplos de PG típicos:
```
01_basico/
02_minio/
03_hdfs/
04_kafka/
05_spark/
06_api/
99_utilidades/
```

### Como crealos
1. Seleccionar procesadores → botón dereito → Group  
ou  
2. Canvas → botón dereito → Process Group → Create.

---

# 2. Deseño dun Process Group limpo

## 2.1. Entradas e saídas claras
Dentro dun PG debería haber:

- Input Ports → para recibir fluxos.
- Output Ports → para enviar resultados.

Regras:

- Unha entrada clara (ou poucas ben nomeadas).
- Saídas ben definidas: success, failure, cleaned, invalid…

---

## 2.2. Nomeado claro e consistente
Recoméndase prefixar procesadores por tipo:

| Prefix | Significado |
|--------|-------------|
| GF_* | GenerateFlowFile |
| PUT_* | Escrita (S3, HDFS, File…) |
| GET_* | Lectura |
| ROUTE_* | Enrutado |
| TRANS_* | Transformación |
| KAFKA_* | Kafka |
| UTIL_* | Utilidades |

---

## 2.3. Labels
Os labels permiten documentar visualmente.

Recomendacións:
- Un label grande co nome do PG.
- Labels pequenos para separar seccións.
- Explicacións curtas de cada bloque.

---

## 2.4. Comments en cada procesador
Aconséllase indicar:
- función do procesador,
- parámetros importantes,
- requisitos previos.

---

## 2.5. Parameter Contexts: configuración reutilizable

Os Parameter Contexts almacenan parámetros clave→valor e poden asociarse a un ou varios PGs. Serven para:

- evitar repetir configuracións,
- separar contornos (dev/test/prod),
- gardar valores sensibles,
- facer fluxos portables.

Diferencia:
- ${atributo} → le un atributo do FlowFile.
- #{parametro} → le un parámetro do Parameter Context.

### 2.5.1. Crear un Parameter Context
1. Barra superior → Settings.  
2. Pestana Parameter Contexts.  
3. Add Parameter Context.  
4. Engadir parámetros, por exemplo:  
   - minio.endpoint → http://minio:9000  
   - minio.access.key → minioadmin (sensitive)  
   - minio.secret.key → minioadmin (sensitive)

### 2.5.2. Asignar o contexto a un PG
1. Dobre clic no Process Group → Settings.  
2. Seleccionar Parameter Context.

### 2.5.3. Usar parámetros nun procesador
Ex. en PutS3Object:

- Endpoint Override → #{minio.endpoint}  
- Access Key → #{minio.access.key}  
- Secret Key → #{minio.secret.key}  
- Bucket → #{minio.bucket}

### 2.5.4. Contextos por entorno
Exemplo:
- dev-minio → http://minio-dev:9000
- prod-minio → https://minio-prod.empresa.com

---

# 3. Importación, exportación e reutilización

## 3.1. Exportar un fluxo
1. Seleccionar o PG.  
2. Botón dereito → Download Flow Definition.  
3. Obtés un JSON con todo o fluxo (sen valores sensibles).

## 3.2. Importar un fluxo
1. Canvas → botón dereito → Upload Flow Definition.  
2. Asignar o Parameter Context correspondente.

---

# 4. Backpressure, concorrencia e control de fluxo

## 4.1. Backpressure
Cada conexión pode limitar:
- número máximo de FlowFiles,
- tamaño total.

Cando se supera → detense o procesador anterior.

Valores recomendados:
- 10.000 FlowFiles  
- 1 GB  

---

## 4.2. Prioritización
Pódense usar:
- oldest first
- newest first
- random
- por atributo
- por tamaño

---

## 4.3. Concurrent Tasks
Define cantos threads usa un procesador.

Por defecto: 1  
En produción: 4, 8 ou máis.

---

## 4.4. Penalización
Se un procesador falla:
- o FlowFile queda penalizado,
- non se reintenta ata pasado un tempo (30s por defecto).

---

# 5. Boas prácticas xerais de deseño

## 5.1. Un procesador = unha función

## 5.2. Poñer LogAttribute ao final dunha rama nova

## 5.3. Non gardar passwords en claro
Usar Parameter Contexts con parámetros sensitive.

## 5.4. Empregar Record Readers e Writers

## 5.5. Eliminar procesadores e conexións sen usar

## 5.6. Canvas limpo e sen cables “espagueti”

---

# 6. Estratexia para fluxos grandes

Estrutura recomendada:
```
Process Group raíz
 ├── ingestion/
 ├── validation/
 ├── transformation/
 ├── enrichment/
 ├── load/
 └── monitoring/
```

---

# 7. Versionado con NiFi Registry

- Configurar Registry Client.
- Sobre un PG → Start version control.
- Realizar commits de cambios.

Fluxo e parámetros quedan separados (Flow Definition + Parameter Context).

---

# 8. Checklist final

- [ ] O fluxo está dentro dun Process Group  
- [ ] Entradas e saídas claras  
- [ ] Labels explicativos  
- [ ] Comments nos procesadores  
- [ ] LogAttribute para probas  
- [ ] Sen procesadores soltos  
- [ ] Backpressure configurado  
- [ ] Passwords en Parameter Contexts  
- [ ] Flow Definition exportado  

---

# Conclusión
Un bo deseño en NiFi fai que os fluxos sexan mantibles, escalables e fáciles de depurar ou ensinar. Os Process Groups, os Parameter Contexts e boas prácticas permiten crear fluxos limpos e profesionais.
