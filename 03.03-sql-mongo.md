# 03.03 Procesadores SQL e MongoDB en Apache NiFi

Este documento recolle fichas completas dos procesadores necesarios para traballar con bases de datos relacionais (SQL) e bases de datos NoSQL (MongoDB) no contexto do módulo.

---

# =============================
# 5. Procesadores SQL / BD Relacionais
# =============================

## 5.1. ExecuteSQL

### 1. Descrición
`ExecuteSQL` executa unha consulta SQL sobre unha base de datos relacional a través dun `DBCPConnectionPool`.  
Xera un FlowFile co resultado da consulta en formato **Avro**.

### 2. Función principal
- Executar SELECT.
- Recuperar datos dunha táboa ou vista.
- Extraer datos para procesalos con Record API.

### 3. Propiedades principais
| Propiedade | Tipo | Descrición |
|------------|------|-------------|
| Database Connection Pooling Service | CS | Referencia a un `DBCPConnectionPool` configurado |
| SQL select query | Texto | Ex: `SELECT * FROM usuarios` |
| Max Rows Per Flow File | Número | Límite de filas por FlowFile |
| Output Batch Size | Número | Cantidade de filas por lote |

### 4. Relacións
| Relación | Significado |
|----------|-------------|
| success  | Recuperación exitosa |
| failure  | Fallo na consulta ou conexión |

### 5. Exemplo típico
```
SELECT id, nome, idade FROM clientes WHERE idade > 18;
```

### 6. Situacións típicas
- Exportar datos da BD cara HDFS, Kafka ou MinIO.
- Alimentar pipelines ETL.
- Preparar datos para ConvertRecord.

### 7. Erros comúns
| Erro | Causa |
|------|-------|
| No suitable driver | Falta o driver JDBC |
| Connection refused | Pool mal configurado |
| SQLSyntaxError | Erro na consulta |

### 8. Boas prácticas
- Limitar filas con Max Rows Per Flow File.
- Usar ConvertRecord para transformar o Avro resultante.
- Non usar para cargas masivas (mellor Spark ou Sqoop).

---

## 5.2. PutSQL

### 1. Descrición
`PutSQL` executa INSERT, UPDATE ou DELETE sobre unha base de datos relacional.

### 2. Función principal
- Inserir rexistros recibidos dende NiFi.
- Actualizar ou borrar filas.
- Usar atributos como parámetros.

### 3. Propiedades principais
| Propiedade | Tipo | Descrición |
|------------|------|-------------|
| Database Connection Pooling Service | CS | Servizo de conexión JDBC |
| SQL Statement | Texto | Sentenza SQL con EL opcional |

### 4. Relacións
| Relación | Significado |
|----------|-------------|
| success  | SQL executado correctamente |
| failure  | Erro SQL ou conectividade |

### 5. Exemplo
```
INSERT INTO lecturas (id, valor, ts)
VALUES (${id}, ${valor}, ${timestamp});
```

### 6. Situacións típicas
- Cargar datos limpos nunha BD OLTP.
- Inserir eventos ou logs.
- Sincronizar sistemas simples.

### 7. Erros comúns
| Erro | Causa |
|------|-------|
| PK violation | Clave primaria duplicada |
| Invalid column | Columna non existe |
| Wrong type | Tipo incorrecto nun campo |

### 8. Boas prácticas
- Validar JSON con ValidateRecord antes de PutSQL.
- Non usar para cargas moi grandes.
- Preferir PutDatabaseRecord para datos estruturados.

---

## 5.3. GenerateTableFetch

### 1. Descrición
`GenerateTableFetch` divide unha lectura SQL grande en fragmentos e xera varias consultas pequenas.

### 2. Función principal
- Paginación de táboas grandes.
- Lectura incremental (incremental fetch).
- Xerar moitos FlowFiles cunha consulta parcial cada un.

### 3. Propiedades principais
| Propiedade | Tipo | Descrición |
|------------|------|-------------|
| Table Name | Texto | Nome da táboa |
| Partitioning Column | Texto | Ex: `id` |
| Max Value Columns | Texto | Lectura incremental |
| Fetch Size | Número | Número de filas por fragmento |

### 4. Relacións
| Relación | Significado |
|----------|-------------|
| success  | Consultas xeradas |
| failure  | Erro |

### 5. Boas prácticas
- Ideal para ETL de táboas grandes.
- Combinar con ExecuteSQL para cada fragmento xerado.

---

## 5.4. DBCPConnectionPool (Controller Service)

### 1. Descrición
Servizo que xestiona conexións JDBC compartidas entre procesadores.

### 2. Propiedades principais
| Propiedade | Descrición |
|------------|-------------|
| Database URL | Ex: `jdbc:postgresql://postgres:5432/db` |
| DB Driver Class | Ex: `org.postgresql.Driver` |
| Driver Location(s) | Ruta ao `.jar` se non está incluído |
| User / Password | Credenciais |
| Validation Query | Ex: `SELECT 1` |

### 3. Boas prácticas
- Gardar credenciais en Parameter Contexts.
- Validar con `SELECT 1` para evitar timeouts.
- Asegurar que o `.jar` JDBC está dispoñible en lib/ do NiFi.

---

# =============================
# 6. Procesadores MongoDB (NoSQL)
# =============================

## 6.1. GetMongo

### 1. Descrición
`GetMongo` executa unha consulta sobre unha colección MongoDB e devolve os documentos como FlowFiles JSON.

### 2. Función principal
- Ler documentos dunha colección.
- Converter BSON a JSON.

### 3. Propiedades principais
| Propiedade | Tipo | Descrición |
|------------|------|-------------|
| Mongo URI | Texto | Ex: `mongodb://mongo:27017` |
| Database Name | Texto | Nome da BD |
| Collection Name | Texto | Colección |
| Query | JSON | Ex: `{ "status": "OK" }` |
| Projection | JSON | Ex: `{ "_id":0, "campo":1 }` |

### 4. Relacións
| Relación | Significado |
|----------|-------------|
| success  | Documentos lidos |
| failure  | Erro |

### 5. Exemplo
```
Query = { "sensor": "temp" }
Projection = { "_id":0, "valor":1, "ts":1 }
```

### 6. Boas prácticas
- Usar Projection para reducir volume.
- Ideal para pipelines ETL.

---

## 6.2. PutMongo

### 1. Descrición
`PutMongo` inserta documentos JSON nunha colección MongoDB.

### 2. Función principal
- Cargar documentos en MongoDB desde NiFi.
- Inserción directa de JSON.

### 3. Propiedades principais
| Propiedade | Tipo | Descrición |
|------------|------|-------------|
| Mongo URI | Texto | Conexión |
| Database Name | Texto | BD |
| Collection Name | Texto | Colección |
| JSON Document | EL | O FlowFile debe conter JSON válido |

### 4. Relacións
| Relación | Significado |
|----------|-------------|
| success  | Inserción correcta |
| failure  | Documento non válido |

### 5. Boas prácticas
- Validar JSON antes con ValidateRecord.
- Evitar documentos moi grandes.

---

## 6.3. QueryMongo

### 1. Descrición
Executa consultas avanzadas a coleccións MongoDB.

### 2. Función principal
- Consultas con filtros.
- Lectura incremental por rango.

### 3. Propiedades principais
| Propiedade | Tipo | Descrición |
|------------|------|-------------|
| Query | JSON | Filtro |
| Sort | JSON | Ordenación |
| Limit | Número | Límite de documentos |

### 4. Boas prácticas
- Non usar para agregacións complexas (usar Spark).
- Ideal para extracción incremental.

---

## 6.4. PutMongoRecord (opcional)

### 1. Descrición
Inserción masiva en Mongo usando Record API, máis eficiente que PutMongo.

### 2. Función principal
- Transformación con Record API → inserción optimizada.

---

## 6.5. GetMongoRecord (opcional)

### 1. Descrición
Versión baseada en Record API para extraer datos estruturados desde Mongo.

---

# FIN DO DOCUMENTO
