# Introduci√≥n a **Apache NiFi**

------------------------------------------------------------------------

## 1. Que √© Apache NiFi?

Apache NiFi √© unha plataforma de integraci√≥n e movemento de datos en continuo desenvolvemento, dese√±ada para automatizar o fluxo de datos
entre sistemas. Est√° baseada no proxecto **Niagara Files** da NSA e est√°
pensada para manipular, enrutar, transformar e monitorizar fluxos de
datos en tempo real.
![logo-nifi](images/Nifi-Vlog-Slides-from-Olivia--4--Jan-18-2024-06-00-00-4998-PM.webp)
NiFi proporciona:

-   movemento fiable de datos,
-   transformaci√≥n flexible,
-   unha interface gr√°fica moi intuitiva baseada en arrastrar e soltar,
-   control total de priorizaci√≥n e pol√≠ticas de transferencia,
-   trazabilidade completa grazas ao sistema *Data Provenance*.

------------------------------------------------------------------------

## 2. Conceptos fundamentais en NiFi

### **FlowFile**

√â a unidade b√°sica de datos dentro de NiFi. Cada FlowFile cont√©n: -
**Contido** (bytes) - **Atributos** (pares clave‚Üívalor)

### **Processor**

Son os "nodos" que realizan acci√≥ns: - ler de fontes externas, -
transformar datos, - enrutar segundo condici√≥ns, - escribir en
destinos, - executar scripts, etc.

### **Relationship**

Cada Processor ten "sa√≠das l√≥xicas" chamadas relationships: -
*success* - *failure* - *retry* - *not matched*, etc.

Serven para conectar procesadores entre si.

### **Connection**

Conecta dous procesadores e act√∫a como unha cola intermedia. Pode ter
l√≠mite de tama√±o e pol√≠ticas como FIFO, LIFO etc.

### **Process Group**

Permite agrupar partes dun fluxo para organizar mellor.

### **Controller Service**

Servizos compartidos reutilizables: - conexi√≥ns S3/MinIO - conexi√≥ns
JDBC - parsers de CSV - servizos de SSL - servizos de cat√°logo etc.

### **Data Provenance**

Permite inspeccionar cada paso polo que pasou un FlowFile: - de onde
veu, - que procesadores o modificaron, - cando, - con que par√°metros.

Ideal para auditor√≠a e depuraci√≥n.

------------------------------------------------------------------------

## 3. Arquitectura de Apache NiFi

Apache NiFi est√° dese√±ado como unha aplicaci√≥n modular e extensible constru√≠da enriba da JVM, optimizada para mover, transformar e monitorizar datos en fluxo. A s√∫a arquitectura segue principios de *Flow-Based Programming* e organiza os seus compo√±entes en capas l√≥xicas e repositorios persistentes.

---

## üéõÔ∏è 3.1. Principios fundamentais  
üîó https://nifi.apache.org/nifi-docs/overview.html

### üîπ Flow-Based Programming
NiFi utiliza o paradigma no que os datos se moven a trav√©s de procesadores conectados. O usuario constr√∫e o fluxo graficamente e def√≠nese:
- que procesadores se executan,
- como se conectan,
- que regras de roteo se aplican,
- como se almacenan e transforman os datos.

---

## 3.2. Arquitectura en niveis (vista l√≥xica)
![arquitectura](images/zero-leader-node.png)
### Web Server
- A interface gr√°fica (UI) est√° servida por un **Jetty web server**.
- Exponse mediante unha **API HTTP(S)** de control e administraci√≥n.
- Permite dese√±ar fluxos, xestionar procesadores, monitorizar o sistema, etc.

### Flow Controller
O cerebro da plataforma:
- asigna **threads** aos procesadores,
- controla planificaci√≥n e concorrencia,
- mant√©n a topolox√≠a do fluxo,
- xestiona back-pressure, prioridades e transacci√≥ns.

### Extensions Framework
NiFi permite cargar extensi√≥ns mediante arquivos **NAR (NiFi Archive)**:
- Processors
- Controller Services
- Reporting Tasks
- Flow Analysis Rules
- Parameter Providers

As extensi√≥ns funcionan dentro da JVM e ampl√≠an a funcionalidade da plataforma.

---

## üóÑÔ∏è 3.3. Repositorios internos

NiFi garante fiabilidade e trazabilidade mantendo tres repositorios principais:

### FlowFile Repository
Garda o **estado e metadatos** dos FlowFiles activos no fluxo.
- Implementaci√≥n por defecto: **Write-Ahead Log**
- Funci√≥n: permitir recuperaci√≥n tras fallos do sistema.

### Content Repository
Onde se gardan os **bytes reais** do contido.
- Implementaci√≥n por defecto: bloques en disco
- Pode distribuirse en varias partici√≥ns para mellorar rendemento.

### Provenance Repository
Rexistra **todos os eventos** de cada FlowFile:
- creaci√≥n
- roteo
- cambios
- escritura
- eliminaci√≥n

Permite auditor√≠a completa e trazabilidade do ciclo de vida dos datos.

---

## 3.4. Outros compo√±entes internos

### Extensions
Procesadores e servizos que executan a l√≥xica do fluxo. Exemplos:
- PutS3Object
- ExecuteScript
- ConsumeMQTT
- PutHDFS

### Administrative Infrastructure
Enc√°rgase de:
- planificaci√≥n global,
- recuperaci√≥n tras apagado,
- auto-carga de extensi√≥ns,
- xesti√≥n de recursos e memoria.

---

## 3.5. Garant√≠as de entrega

NiFi garante:

- **At-least-once delivery**
- Transacci√≥ns entre conexi√≥ns
- Recuperaci√≥n autom√°tica tras fallos
- Integridade en todo o ciclo de vida do FlowFile

---

## 3.6. Back Pressure e Prioritizaci√≥n

Para evitar saturaci√≥n:
- cada conexi√≥n pode limitar n√∫mero de FlowFiles e tama√±o ocupado,
- cando un l√≠mite se supera ‚Üí **Back Pressure** det√©n o procesador anterior,
- p√≥dense configurar **prioritizadores**: FIFO, LIFO, oldest-first, etc.

---

## 3.7. Clustering

NiFi pode escalar horizontalmente:

- todos os n√≥s executan o mesmo fluxo,
- Zookeeper coordina o cl√∫ster,
- un **n√≥ l√≠der** toma certas decisi√≥ns administrativas,
- UI √∫nica para todo o cl√∫ster,
- balanceo e tolerancia a fallos.

---

## 3.8. Resumo da arquitectura

| Compo√±ente | Funci√≥n |
|-----------|---------|
| **Web Server** | Servidor Jetty + API HTTP(S) para control |
| **Flow Controller** | Orquestrador central de execuci√≥n |
| **Extensions** | Procesadores e servizos cargados en tempo de execuci√≥n |
| **FlowFile Repository** | Metadatos e estado dos FlowFiles |
| **Content Repository** | Bytes reais do contido |
| **Provenance Repository** | Historial completo de eventos |
| **Cluster Manager (ZK)** | Coordinaci√≥n dos n√≥s dun cl√∫ster |

---

## 3.9. Resumo textual dos compo√±entes segundo a documentaci√≥n oficial

**Web Server**  
> Enc√°rgase de ofrecer a API e a interface web.

**Flow Controller**  
> A l√≥xica central que asigna threads, planifica execuci√≥n e controla o fluxo.

**Extensions**  
> Procesadores, servizos e tarefas que se executan na JVM.

**FlowFile Repository**  
> Onde se almacena o estado interno de cada FlowFile activo.

**Content Repository**  
> Almac√©n f√≠sico dos bytes dos FlowFiles no sistema de ficheiros.

**Provenance Repository**  
> Rexistro de todos os eventos e cambios que experimentou cada FlowFile.

**Clustering**  
> Os nodos poden unirse para formar un cl√∫ster coordinado por ZooKeeper.


------------------------------------------------------------------------

# 4. NiFi en Docker --- Configuraci√≥n completa

A seguinte configuraci√≥n est√° lista para engadir a un 
`docker-compose.yml`.

Hai que asegurarse de que estea na mesma rede que o resto de servizos e declarar os volumes ao final do documento.

Incl√∫e: - NiFi 2.5.0 (UI cl√°sica, m√°is estable) - HTTPS - usuario


------------------------------------------------------------------------

## Servizo Docker (pegado literal, listo para usar)

``` yaml
  nifi:
    image: apache/nifi:2.5.0
    container_name: nifi
    hostname: nifi
    restart: unless-stopped
    depends_on:
      - minio
      - namenode

    ports:
      - "9091:8443"  # NiFi en https://localhost:9091/nifi

    environment:
      # Modo seguro por defecto (HTTPS)
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_HTTPS_HOST=0.0.0.0

      # Proxy para que funcionen os enlaces internos da UI con port mapping
      - NIFI_WEB_PROXY_HOST=localhost:9091

      # Usuario √∫nico
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=Admin$BDA123!

      # JVM
      - NIFI_JVM_HEAP_INIT=512m
      - NIFI_JVM_HEAP_MAX=2g

      # UI cl√°sica e funcionalidades est√°ndar
      - NIFI_UI_BUNDLES_ENABLE=all
      - NIFI_STATELESS_ENABLED=false

    networks:
      - cluster

    volumes:
      - nifi_state:/opt/nifi/nifi-current/state
      - nifi_logs:/opt/nifi/nifi-current/logs
```

------------------------------------------------------------------------

# 5. Ola Mundo con NiFi

Este √© o fluxo m√°is b√°sico posible:

## Procesadores:

1Ô∏è. **GenerateFlowFile**\
‚Üí crea FlowFiles peri√≥dicos.

2Ô∏è. **LogAttribute**\
‚Üí escribe os atributos no log de NiFi.

### Configuraci√≥n:

### **GenerateFlowFile**

-   *Custom Text* ‚Üí `Ola mundo desde NiFi`
-   *Run Schedule* ‚Üí `5 sec`
-   *Batch Size* ‚Üí `1`

### **LogAttribute**

Para que se vexa o contido do *FlowFile* no log:
-   *Log payload* ‚Üí `true`

### Conexi√≥n:

`GenerateFlowFile (success) ‚Üí LogAttribute`

### Execuci√≥n:

1.  Start en GenerateFlowFile\
2.  Start en LogAttribute\
3.  Mira os logs `docker logs -f nifi` (asumindo que ese e o nome do contedor).

------------------------------------------------------------------------

# Ola Mundo 2: Subir a MinIO 

Este fluxo crea un ficheiro e s√∫beo ao bucket `nifi-test` en MinIO.

## Procesadores:

1Ô∏è. **GenerateFlowFile**\
2Ô∏è. **UpdateAttribute**\
3Ô∏è. **PutS3Object** (funcionando con MinIO via Controller Service)

------------------------------------------------------------------------

## Paso 1 --- GenerateFlowFile

-   *Custom Text*:\
    `Este √© un ficheiro xerado automaticamente por NiFi`

------------------------------------------------------------------------

## Paso 2 --- UpdateAttribute

Engade atributos necesarios (o bucket ten que existir previamente):

  Atributo   Valor
  ---------- ---------------
  bucket     nifi-test
  filename   `nifi-${now():format('yyyyMMdd-HHmms')}.txt`


------------------------------------------------------------------------

## Paso 4 --- Configurar PutS3Object

-   **Bucket** ‚Üí `${bucket}`
-   **Object Key** ‚Üí `${filename}`
-   **Endpoint Override URL** ‚Üí `http://minio:9000`
-   **Use Path Style Access** ‚Üí `true`
-   **AWS Credentials Provider Service** ‚Üí ... ‚Üí `create new service`
  - Seleccionamos `AWSCredentialsProviderController` ‚Üí `Add`
  - Volvemos clicar nos `...` ‚Üí `Go to service`.
    - No servicio clicamos nos `...` e configuramos:
      - *Access Key ID* ‚Üí `minioadmin` (cambiar por usuario de minio)
      - *Secret Access Key* ‚Üí `minioadmin` (cambiar por contrasinal de minio).
    - Clicamos nos `...` ‚Üí `Enable`
  - En `Relationships` po√±emos todo a `Terminate`.

Conectar: `GenerateFlowFile ‚Üí UpdateAttribute ‚Üí PutS3Object`

------------------------------------------------------------------------

## Probar:

1.  Start todos os procesadores\
2.  Ver en http://localhost:9001 (MinIO)\
3.  Abrir o bucket `nifi-test`\
4.  Ver os ficheiros subidos

------------------------------------------------------------------------
# Bibliograf√≠a e Recursos

- **Apache NiFi Official Documentation**  
  https://nifi.apache.org/docs.html  
  Documentaci√≥n oficial do proxecto: referencia completa de procesadores, API REST, configuraci√≥n, clustering e seguridade.

- **NiFi User Guide**  
  https://nifi.apache.org/docs/nifi-docs/html/user-guide.html  
  Explica o funcionamento b√°sico da interface, FlowFiles, Connections, Process Groups e conceptos fundamentais.

- **NiFi Administration Guide**  
  https://nifi.apache.org/docs/nifi-docs/html/administration-guide.html  
  Gu√≠a centrada en instalaci√≥n, rendemento, tuning, configuraci√≥n de repositorios e modo cluster.

- **NiFi Expression Language Guide**  
  https://nifi.apache.org/docs/nifi-docs/html/expression-language-guide.html  
  Referencia esencial para crear rutas din√°micas, transformar atributos e empregar funci√≥ns EL.

- **NiFi Record-Based Processing Guide**  
  https://nifi.apache.org/docs/nifi-docs/html/record-path-guide.html  
  Imprescindible para traballar con Readers, Writers e Record Path.

- **Apache NiFi Registry Documentation**  
  https://nifi.apache.org/registry.html  
  Documentaci√≥n sobre versionado de fluxos e integraci√≥n con NiFi Registry.

- **Apache NiFi Stateless Documentation**  
  https://nifi.apache.org/docs/nifi-docs/html/stateless-guide.html  
  Gu√≠a sobre execuci√≥n stateless ideal para integraci√≥n con Airflow ou contornos serverless.

- **Libro: *Flow-Based Programming* ‚Äî J. Paul Morrison**  
  A base conceptual detr√°s do dese√±o de NiFi e outros sistemas baseados en fluxo.

- **Artigo t√©cnico: "NiFi Best Practices" (Cloudera/Community)**  
  https://community.cloudera.com/t5/Community-Articles/NiFi-Best-Practices/ta-p/248233  
  Colecci√≥n de boas pr√°cticas e patr√≥ns de dese√±o recomendados para fluxos complexos.



